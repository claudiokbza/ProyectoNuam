{% extends 'core/base.html' %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0 text-nuam fw-bold"><i class="bi bi-table"></i> Calificaciones Tributarias</h5>
            
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-nuam" data-bs-toggle="modal" data-bs-target="#modalCalificacion">
                    <i class="bi bi-plus-lg"></i> Nuevo Registro
                </button>
                
                <a href="#" class="btn btn-success text-white">
                    <i class="bi bi-file-earmark-excel"></i> Carga Masiva
                </a>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="bg-light p-3 border-bottom">
            <form class="row g-2 align-items-center">
                <div class="col-auto">
                    <select class="form-select form-select-sm">
                        <option selected>Todos los Mercados</option>
                        <option>Acciones</option>
                        <option>CFI</option>
                    </select>
                </div>
                <div class="col-auto">
                    <input type="text" class="form-control form-control-sm" placeholder="Buscar Instrumento...">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-secondary btn-sm">Buscar</button>
                </div>
            </form>
        </div>

        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-hover table-striped mb-0 text-nowrap align-middle">
                <thead class="table-dark">
                    <tr>
                        <th style="position: sticky; left: 0; z-index: 10; background-color: #343a40;">Instrumento</th>
                        <th style="position: sticky; left: 0; z-index: 10; background-color: #343a40;">Ejercicio</th>
                        
                        <th>Monto Total</th>
                        <th>F08 (Crédito IDPC)</th>
                        <th>F09 (Acum. 2016)</th>
                        <th>F10 (IDPC Vol.)</th>
                        <th>F11 (Sin Der.)</th>
                        <th>F12 (Rentas RAP)</th>
                        <th>F37 (Otros)</th>
                        <th>Origen</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in calificaciones %}
                    <tr>
                        <td style="position: sticky; left: 0; background-color: white; z-index: 5;" class="fw-bold">{{ c.instrumento }}</td>
                        <td style="position: sticky; left: 0; background-color: white; z-index: 5;">{{ c.ejercicio }}</td>
                        
                        <td>${{ c.monto_total }}</td>
                        <td>{{ c.factor_08 }}</td>
                        <td>{{ c.factor_09 }}</td>
                        <td>{{ c.factor_10 }}</td>
                        <td>{{ c.factor_11 }}</td>
                        <td>{{ c.factor_12 }}</td>
                        
                        <td>{{ c.factor_37 }}</td>
                        <td><span class="badge bg-info text-dark">{{ c.origen }}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="12" class="text-center py-4 text-muted">
                            No hay calificaciones registradas para este usuario.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCalificacion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            
            <form method="POST"> 
                
                {% csrf_token %} <div class="modal-header text-white" style="background-color: #003366;">
                    <h5 class="modal-title text-white">Nueva Calificación Tributaria</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    
                    <div class="row g-3 mb-4 p-3 bg-light rounded border">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-nuam">Instrumento</label>
                            <select name="instrumento" class="form-select" required>
                                <option value="">Seleccione...</option>
                                {% for inst in instrumentos %}
                                    <option value="{{ inst.id }}">{{ inst.codigo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold text-nuam">Ejercicio</label>
                            <input type="number" name="ejercicio" class="form-control" value="2025" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-nuam">Fecha Pago</label>
                            <input type="date" name="fecha_pago" class="form-control" required>
                        </div>
                         <div class="col-md-4">
                            <label class="form-label fw-bold text-nuam">Descripción Evento</label>
                            <input type="text" name="descripcion" class="form-control" placeholder="Ej. Dividendo Provisorio">
                        </div>
                    </div>

                    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-generales" type="button">1. Montos</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-creditos" type="button">2. Créditos (F08-F19)</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rentas" type="button">3. Rentas (F20-F29)</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-otros" type="button">4. Otros (F30-F37)</button></li>
                    </ul>

                    <div class="tab-content">
                        
                        <div class="tab-pane fade show active" id="tab-generales">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Monto Total ($)</label>
                                    <input type="number" step="0.01" name="monto_total" class="form-control" placeholder="0.00">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-secondary">Valor Histórico</label>
                                    <input type="number" step="0.01" name="valor_historico" class="form-control" placeholder="0.00">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-secondary">Factor Actualización</label>
                                    <input type="number" step="0.000001" name="factor_actualizacion" class="form-control" value="1.0">
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-creditos">
                            <div class="alert alert-light border small text-muted">
                                <i class="bi bi-info-circle"></i> La suma de F08 a F19 debe ser <strong><= 1.0</strong>.
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small text-nuam">F08 (Con Crédito IDPC)</label>
                                    <input type="number" step="0.00000001" name="factor_08" class="form-control factor-check" placeholder="0.00000000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-nuam">F09 (Acum. 2016)</label>
                                    <input type="number" step="0.00000001" name="factor_09" class="form-control factor-check" placeholder="0.00000000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-nuam">F10 (IDPC Voluntario)</label>
                                    <input type="number" step="0.00000001" name="factor_10" class="form-control factor-check" placeholder="0.00000000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-secondary">F11 (Sin Der. Crédito)</label>
                                    <input type="number" step="0.00000001" name="factor_11" class="form-control factor-check" placeholder="0.00000000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-secondary">F12 (Rentas RAP)</label>
                                    <input type="number" step="0.00000001" name="factor_12" class="form-control factor-check" placeholder="0.00000000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-secondary">F13 (Otras Rentas)</label>
                                    <input type="number" step="0.00000001" name="factor_13" class="form-control factor-check" placeholder="0.00000000">
                                </div>
                                <div class="col-md-4"><label class="form-label small text-secondary">F14</label><input type="number" step="0.00000001" name="factor_14" class="form-control factor-check"></div>
                                <div class="col-md-4"><label class="form-label small text-secondary">F15</label><input type="number" step="0.00000001" name="factor_15" class="form-control factor-check"></div>
                                <div class="col-md-4"><label class="form-label small text-secondary">F16</label><input type="number" step="0.00000001" name="factor_16" class="form-control factor-check"></div>
                                <div class="col-md-4"><label class="form-label small text-secondary">F17</label><input type="number" step="0.00000001" name="factor_17" class="form-control factor-check"></div>
                                <div class="col-md-4"><label class="form-label small text-secondary">F18</label><input type="number" step="0.00000001" name="factor_18" class="form-control factor-check"></div>
                                <div class="col-md-4"><label class="form-label small text-secondary">F19</label><input type="number" step="0.00000001" name="factor_19" class="form-control factor-check"></div>
                            </div>

                            <div class="mt-3 p-2 bg-light border rounded text-end">
                                <strong>Suma Actual: <span id="suma-total">0.00000000</span> / 1.0</strong>
                                <span id="msg-error" class="text-danger fw-bold d-none ms-2">ERROR: > 1.0</span>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-rentas">
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label small">F20 (ISFUT)</label><input type="number" step="0.00000001" name="factor_20" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F21</label><input type="number" step="0.00000001" name="factor_21" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F22</label><input type="number" step="0.00000001" name="factor_22" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F23</label><input type="number" step="0.00000001" name="factor_23" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F24</label><input type="number" step="0.00000001" name="factor_24" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F25</label><input type="number" step="0.00000001" name="factor_25" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F26</label><input type="number" step="0.00000001" name="factor_26" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F27</label><input type="number" step="0.00000001" name="factor_27" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F28</label><input type="number" step="0.00000001" name="factor_28" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F29</label><input type="number" step="0.00000001" name="factor_29" class="form-control"></div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="tab-otros">
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label small">F30</label><input type="number" step="0.00000001" name="factor_30" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F31</label><input type="number" step="0.00000001" name="factor_31" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F32</label><input type="number" step="0.00000001" name="factor_32" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F33 (Crédito IPE)</label><input type="number" step="0.00000001" name="factor_33" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F34</label><input type="number" step="0.00000001" name="factor_34" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F35</label><input type="number" step="0.00000001" name="factor_35" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F36</label><input type="number" step="0.00000001" name="factor_36" class="form-control"></div>
                                <div class="col-md-4"><label class="form-label small">F37 (Otros)</label><input type="number" step="0.00000001" name="factor_37" class="form-control"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" id="btn-guardar" class="btn text-white" style="background-color: #003366;">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Seleccionamos SOLO los inputs que tienen la clase 'factor-check' (F08 a F19)
        const inputs = document.querySelectorAll('.factor-check');
        const displaySuma = document.getElementById('suma-total');
        const msgError = document.getElementById('msg-error');
        const btnGuardar = document.getElementById('btn-guardar');

        function calcular() {
            let total = 0;
            inputs.forEach(input => {
                // Si el campo está vacío, cuenta como 0
                total += parseFloat(input.value) || 0;
            });
            
            // Mostramos con 8 decimales
            displaySuma.textContent = total.toFixed(8);

            if (total > 1.00000000) {
                // Si se pasa de 1, mostramos error y bloqueamos botón
                msgError.classList.remove('d-none');
                btnGuardar.disabled = true;
                displaySuma.classList.add('text-danger');
            } else {
                // Si está bien, todo normal
                msgError.classList.add('d-none');
                btnGuardar.disabled = false;
                displaySuma.classList.remove('text-danger');
            }
        }

        inputs.forEach(input => {
            input.addEventListener('input', calcular);
        });
    });
</script>
{% endblock %}