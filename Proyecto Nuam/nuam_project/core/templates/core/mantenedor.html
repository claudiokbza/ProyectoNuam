{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary"><i class="bi bi-file-earmark-spreadsheet"></i> Mantenedor de Calificaciones</h2>
            <p class="text-muted">Gesti√≥n de Dividendos y Factores Tributarios</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#modalCargaMasiva">
                <i class="bi bi-file-earmark-excel"></i> Carga Masiva
            </button>
            
            <button type="button" class="btn btn-primary btn-lg shadow-sm" onclick="abrirModalCrear()">
                <i class="bi bi-plus-circle"></i> Nueva Calificaci√≥n
            </button>
        </div>
    </div>



    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle w-100" id="tablaCalificaciones" style="font-size: 0.85rem;">
                    <thead class="table-light sticky-header">
                        <tr>
                            <th class="text-center bg-light">N¬∞ Div.</th>
                            <th class="text-center">RUT Prop.</th>
                            <th class="text-start">Instrumento</th>
                            
                            {% if user.is_superuser %}
                                <th class="text-center text-primary bg-light">Usuario (Creador)</th>
                            {% endif %}

                            <th class="text-center">Fecha Pago</th>
                            <th class="text-end">Monto Hist√≥rico</th>
                            <th class="text-center">Factor</th>
                            <th class="text-end fw-bold bg-light">Monto Actualizado</th>
                            <th class="text-center">ISFUT</th>
                            <th class="text-center">Acciones</th>
                            {% for f_num in rango_factores %}
                                <th class="text-center small text-muted" style="min-width: 50px;">F{{ f_num|stringformat:"02d" }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in calificaciones %}
                        <tr>
                            <td class="text-center fw-bold text-secondary">{{ c.id }}</td>
                            <td class="text-center font-monospace small">{{ c.rut_propietario }}</td>
                            
                            <td class="fw-bold text-primary" title="C√≥digo: {{ c.instrumento.codigo }}">
                                {{ c.instrumento.nombre }}
                            </td>

                            {% if user.is_superuser %}
                                <td class="text-center">
                                    <span class="badge bg-warning text-dark border border-dark">
                                        <i class="bi bi-person-fill"></i> {{ c.usuario.username }}
                                    </span>
                                </td>
                            {% endif %}

                            <td class="text-center">{{ c.fecha_pago|date:"d/m/Y" }}</td>
                            <td class="text-end text-muted">${{ c.monto_historico|floatformat:0|intcomma }}</td>
                            <td class="text-center">{{ c.factor_actualizacion|floatformat:6 }}</td>
                            <td class="text-end text-success fw-bold bg-light">${{ c.monto_total|floatformat:0|intcomma }}</td>
                            <td class="text-center">{% if c.es_isfut %}<span class="badge bg-success">SI</span>{% else %}-{% endif %}</td>
                            
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-warning border-0 btn-editar" 
                                        data-id="{{ c.id }}"
                                        data-rut="{{ c.rut_propietario }}"
                                        data-instrumento="{{ c.instrumento.id }}"
                                        data-ejercicio="{{ c.ejercicio }}"
                                        data-fecha="{{ c.fecha_pago|date:'Y-m-d' }}"
                                        data-monto-hist="{{ c.monto_historico|stringformat:'f' }}"
                                        data-monto-total="{{ c.monto_total|stringformat:'f' }}"
                                        data-factor-act="{{ c.factor_actualizacion|stringformat:'f' }}"
                                        data-descripcion="{{ c.descripcion }}"
                                        data-secuencia="{{ c.secuencia }}"
                                        data-isfut="{{ c.es_isfut|yesno:'true,false' }}"
                                        data-factores='{ {% for f in rango_factores %}"f{{ f|stringformat:"02d" }}": {{ c|get_factor_value:f|default:0|stringformat:"f" }}{% if not forloop.last %}, {% endif %}{% endfor %} }'>
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger border-0" onclick="eliminarRegistro('{{ c.id }}')"><i class="bi bi-trash"></i></button>
                            </td>

                            {% for f_num in rango_factores %}
                                <td class="text-end text-muted">{{ c|get_factor_value:f_num|default:"-"|floatformat:6 }}</td>
                            {% endfor %}
                        </tr>
                        {% empty %}
                        <tr><td colspan="45" class="text-center py-5">No hay registros.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFormulario" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl"> 
        <div class="modal-content">
            <form method="POST" action="{% url 'mantenedor' %}" id="formMantenedor" onsubmit="return validarFormularioFinal()">
                {% csrf_token %}
                <input type="hidden" name="id_edicion" id="id_edicion">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="modalTitulo">Ingreso de Dividendo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body bg-light">
                    
                    <div id="paso-1-datos">
                        <h6 class="text-primary border-bottom pb-2 mb-3 fw-bold">Paso 1: Identificaci√≥n y Montos</h6>
                        
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label fw-bold text-secondary">N¬∞ ID</label>
                                <input type="text" id="inputVisualId" class="form-control bg-light fw-bold text-center" value="(Nuevo)" readonly tabindex="-1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold text-danger">RUT Propietario (*)</label>
                                <input type="text" name="rut_propietario" id="inputRut" class="form-control" 
                                    placeholder="12345678-9" required 
                                    oninput="formatearRut(this)" onblur="validarRutInput(this)">
                                <div class="invalid-feedback">RUT Inv√°lido</div>
                            </div>

                            <div class="col-md-5">
                                <label class="form-label fw-bold">Instrumento (*)</label>
                                <select name="instrumento" id="inputInstrumento" class="form-select" required>
                                    <option value="">Seleccione...</option>
                                    {% for i in instrumentos %}
                                        <option value="{{ i.id }}">{{ i.nombre }} ({{ i.codigo }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Fecha Pago (*)</label>
                                <input type="date" name="fecha_pago" id="inputFechaPago" class="form-control" required>
                            </div>

                            <input type="hidden" name="ejercicio" id="inputEjercicio" value="2025">

                            <div class="col-md-4">
                                <label class="form-label fw-bold text-primary">Monto Hist√≥rico ($)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="1" name="monto_historico" id="inputMontoHistorico" class="form-control fw-bold" required onchange="recalcularTotal()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Factor Actualizaci√≥n</label>
                                <input type="number" step="0.000001" name="factor_actualizacion" id="inputFactorAct" class="form-control" value="1.000000" onchange="recalcularTotal()">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold text-success">Monto Actualizado (Base)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-success text-white">$</span>
                                    <input type="number" step="1" id="inputMontoActualizadoVisual" class="form-control fw-bold bg-white text-success" readonly>
                                </div>
                            </div>

                            <div class="col-md-8">
                                <label class="form-label">Descripci√≥n</label>
                                <input type="text" name="descripcion" id="inputDescripcion" class="form-control">
                            </div>
                            <div class="col-md-4 d-flex align-items-center mt-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="es_isfut" id="inputIsfut">
                                    <label class="form-check-label fw-bold" for="inputIsfut">¬øEs ISFUT?</label>
                                </div>
                            </div>
                            <input type="hidden" name="secuencia" id="inputSecuencia" value="0">
                        </div>
                    </div>

                    <div id="paso-2-factores" class="d-none animate__animated animate__fadeIn">
                        
                        <div class="alert alert-info py-2 mb-3 d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-info-circle"></i> Ingrese los montos reajustados. El sistema calcular√° los factores.</span>
                            <span class="badge bg-white text-dark border">Base: $<span id="lblBaseCalculo">0</span></span>
                        </div>

                        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                            {% for key, grupo in grupos.items %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                        id="tab-btn-{{ key }}" 
                                        data-bs-toggle="tab" 
                                        data-bs-target="#tab-content-{{ key }}" 
                                        type="button" role="tab">
                                    {{ grupo.titulo|truncatechars:20 }} </button>
                            </li>
                            {% endfor %}
                        </ul>

                        <div class="tab-content" id="myTabContent">
                            {% for key, grupo in grupos.items %}
                            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="tab-content-{{ key }}" role="tabpanel">
                                
                                <h6 class="text-{{ grupo.color }} border-bottom pb-2 mb-3 fw-bold">{{ grupo.titulo }}</h6>
                                
                                <div class="row g-3">
                                    <div class="col-12 d-flex px-2 text-muted small fw-bold">
                                        <div style="width: 50%;">Concepto</div>
                                        <div style="width: 25%; text-align: center;">Monto ($)</div>
                                        <div style="width: 25%; text-align: center;">Factor Calc.</div>
                                    </div>

                                    {% for factor in grupo.factores %}
                                    <div class="col-12"> <div class="row align-items-center g-1">
                                            
                                            <div class="col-6">
                                                <label for="{{ factor.id }}" class="small mb-0 fw-bold text-secondary" title="{{ factor.ayuda }}">
                                                    {{ factor.label }}
                                                </label>
                                            </div>

                                            <div class="col-3">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text text-success">$</span>
                                                    <input type="number" step="0.01" 
                                                        class="form-control input-monto-calculo text-end fw-bold" 
                                                        id="{{ factor.id }}" 
                                                        name="{{ factor.id }}" 
                                                        placeholder="0">
                                                </div>
                                            </div>

                                            <div class="col-3">
                                                <input type="text" 
                                                    class="form-control form-control-sm text-end text-muted input-factor-visual" 
                                                    id="visual_{{ factor.id }}" 
                                                    readonly 
                                                    placeholder="0.00000000"
                                                    style="background-color: #f8f9fa;">
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                            </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>

                <div class="modal-footer bg-light justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="cerrarOVolver()" id="btnVolver">Cancelar</button>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-info text-white fw-bold d-none" id="btnCalcular" onclick="ejecutarCalculoMasivo()">
                            <i class="bi bi-calculator"></i> Calcular Factores
                        </button>

                        <button type="button" class="btn btn-primary px-4 fw-bold" id="btnSiguiente" onclick="irAlPaso2()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                        
                        <button type="submit" class="btn btn-success px-4 fw-bold d-none" id="btnGuardar">
                            <i class="bi bi-save"></i> Guardar Finalizar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog">
        <form method="POST" action="{% url 'mantenedor' %}">
            {% csrf_token %}
            <input type="hidden" name="accion_eliminar" value="true">
            <input type="hidden" name="id_seleccionado" id="id_eliminar_input">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white"><h5 class="modal-title">Eliminar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center"><p>¬øSeguro que desea eliminar este registro?</p></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button><button type="submit" class="btn btn-danger">S√≠, Eliminar</button></div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalCargaMasiva" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="POST" action="{% url 'carga_masiva' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-cloud-upload"></i> Carga Masiva de Dividendos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light border-success d-flex align-items-center mb-3">
                        <i class="bi bi-info-circle-fill text-success fs-4 me-3"></i>
                        <div>
                            <strong>Instrucciones:</strong>
                            <ul class="mb-0 small text-secondary">
                                <li>Formato admitido: <strong>.CSV</strong> (separado por punto y coma ; o comas).</li>
                                <li>Columnas Obligatorias: <strong>RUT, Instrumento, Fecha, Monto Historico, F08...F37</strong>.</li>
                                <li>Si no incluye "Factor", se asume 1.0.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Seleccionar Archivo CSV</label>
                        <input type="file" name="archivo_excel" id="input_archivo_csv" class="form-control" accept=".csv" required onchange="previsualizarCSV()">
                    </div>

                    <div id="zona-preview" class="d-none">
                        <h6 class="fw-bold text-success border-bottom pb-2">Vista Previa</h6>
                        <div class="table-responsive border rounded" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover table-striped mb-0 text-nowrap small" id="tabla-preview">
                                <thead class="table-success"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="error-preview" class="alert alert-danger mt-3 d-none">
                        <i class="bi bi-exclamation-triangle-fill"></i> <span id="msg-error-csv"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-confirmar-carga" disabled>Confirmar Carga</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DE RUT CHILENO ---
    function formatearRut(input) {
        let valor = input.value.replace(/[^0-9kK]/g, "");
        if (valor.length > 1) {
            let cuerpo = valor.slice(0, -1);
            let dv = valor.slice(-1).toUpperCase();
            input.value = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "-" + dv;
        } else {
            input.value = valor;
        }
    }
    function validarRutInput(input) {
        let rut = input.value;
        if (!Fn.validaRut(rut)) {
            input.classList.add("is-invalid"); input.classList.remove("is-valid");
            return false;
        } else {
            input.classList.remove("is-invalid"); input.classList.add("is-valid");
            return true;
        }
    }
    var Fn = {
        validaRut : function (rutCompleto) {
            if (!/^[0-9]+[-|‚Äê]{1}[0-9kK]{1}$/.test( rutCompleto ))
                if (!/^[0-9]+[-|‚Äê]{1}[0-9kK]{1}$/.test( rutCompleto.replace(/\./g, '') )) return false;
            var tmp = rutCompleto.split('-');
            if(tmp.length < 2) tmp = rutCompleto.replace(/\./g, '').split('-');
            var digv = tmp[1]; var rut = tmp[0].replace(/\./g, '');
            if ( digv == 'K' ) digv = 'k' ;
            return (Fn.dv(rut) == digv );
        },
        dv : function(T){
            var M=0,S=1;
            for(;T;T=Math.floor(T/10)) S=(S+T%10*(9-M++%6))%11;
            return S?S-1:'k';
        }
    }

    // --- NAVEGACI√ìN WIZARD ACTUALIZADA ---
    function irAlPaso2() {
        // Validaciones Paso 1 (Igual que antes)
        const rut = document.getElementById('inputRut');
        const inst = document.getElementById('inputInstrumento');
        const fecha = document.getElementById('inputFechaPago');
        const hist = document.getElementById('inputMontoHistorico');

        if(!rut.value || rut.classList.contains('is-invalid')) { alert("RUT inv√°lido."); rut.focus(); return; }
        if(!inst.value) { alert("Seleccione Instrumento."); inst.focus(); return; }
        if(!fecha.value) { alert("Ingrese Fecha."); fecha.focus(); return; }
        if(parseFloat(hist.value) <= 0) { alert("El monto debe ser > 0."); hist.focus(); return; }

        // Cambiar vista
        document.getElementById('paso-1-datos').classList.add('d-none');
        document.getElementById('paso-2-factores').classList.remove('d-none');
        
        // Ajustar botones
        document.getElementById('btnSiguiente').classList.add('d-none');
        document.getElementById('btnGuardar').classList.remove('d-none');
        document.getElementById('btnCalcular').classList.remove('d-none'); // MOSTRAR BOT√ìN CALCULAR
        
        document.getElementById('btnVolver').innerText = "Atr√°s (Datos)";
        document.getElementById('btnVolver').onclick = volverAlPaso1;

        document.getElementById('lblBaseCalculo').innerText = document.getElementById('inputMontoActualizadoVisual').value;
    }

    function volverAlPaso1() {
        document.getElementById('paso-2-factores').classList.add('d-none');
        document.getElementById('paso-1-datos').classList.remove('d-none');
        
        document.getElementById('btnGuardar').classList.add('d-none');
        document.getElementById('btnCalcular').classList.add('d-none'); // OCULTAR BOT√ìN CALCULAR
        document.getElementById('btnSiguiente').classList.remove('d-none');
        
        document.getElementById('btnVolver').innerText = "Cancelar";
        document.getElementById('btnVolver').onclick = cerrarOVolver;
    }

    // --- NUEVA FUNCI√ìN DE C√ÅLCULO ---
    function ejecutarCalculoMasivo() {
        // 1. Obtener la base (Monto Actualizado Total)
        const base = parseFloat(document.getElementById('inputMontoActualizadoVisual').value) || 0;

        if (base <= 0) {
            alert("‚ö†Ô∏è El monto base actualizado es 0. No se pueden calcular factores.");
            return;
        }

        // 2. Recorrer todos los inputs de monto ($)
        const inputsMonto = document.querySelectorAll('.input-monto-calculo');
        let contador = 0;

        inputsMonto.forEach(input => {
            let monto = parseFloat(input.value);
            // Buscamos el input visual correspondiente (tiene id "visual_fXX")
            let idVisual = "visual_" + input.id;
            let inputVisual = document.getElementById(idVisual);

            if (inputVisual) {
                if (!isNaN(monto) && monto >= 0) {
                    // C√ÅLCULO: Monto / Base
                    let factor = monto / base;
                    // Mostramos con 8 decimales
                    inputVisual.value = factor.toFixed(8);
                    contador++;
                } else {
                    inputVisual.value = ""; // Limpiar si no hay monto
                }
            }
        });

        if (contador > 0) {
            // Feedback visual suave (opcional)
            alert("‚úÖ C√°lculo realizado sobre " + contador + " campos.");
        }
    }

    function cerrarOVolver() {
        // Si estamos en modo "Cancelar", cerramos el modal
        var myModalEl = document.getElementById('modalFormulario');
        var modal = bootstrap.Modal.getInstance(myModalEl);
        modal.hide();
    }

    function validarFormularioFinal() {
        // Validaciones finales antes de submit
        return true;
    }



    // --- FUNCI√ìN HELPER PARA FORMATO CHILENO ---
    const formateadorPesos = new Intl.NumberFormat('es-CL', {
        style: 'decimal',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
    });

    function recalcularTotal() {
        let hist = parseFloat(document.getElementById('inputMontoHistorico').value) || 0;
        let fact = parseFloat(document.getElementById('inputFactorAct').value) || 1;
        
        // C√ÅLCULO: Redondear a cero decimales
        let total = Math.round(hist * fact);
        
        // Guardamos el valor limpio en el input (o en un hidden si fuera necesario submitir)
        // Pero para el visual readonly, usamos formato con puntos:
        document.getElementById('inputMontoActualizadoVisual').value = formateadorPesos.format(total);
        
        // Guardamos el valor num√©rico real en un atributo data para usarlo en c√°lculos matem√°ticos
        document.getElementById('inputMontoActualizadoVisual').dataset.valorReal = total;
    }

    function ejecutarCalculoMasivo() {
        // Obtenemos la base desde el dataset (n√∫mero limpio) o limpiando el formato visual
        let valVisual = document.getElementById('inputMontoActualizadoVisual').value;
        // Quitamos puntos para poder dividir matem√°ticamente
        let base = parseFloat(valVisual.replace(/\./g, '')) || 0;

        if (base <= 0) {
            alert("‚ö†Ô∏è El monto base es 0."); return;
        }

        const inputsMonto = document.querySelectorAll('.input-monto-calculo');
        let contador = 0;

        inputsMonto.forEach(input => {
            let monto = parseFloat(input.value); // El input type="number" entrega valor limpio
            let idVisual = "visual_" + input.id;
            let inputVisual = document.getElementById(idVisual);

            if (inputVisual) {
                if (!isNaN(monto) && monto >= 0) {
                    let factor = monto / base;
                    inputVisual.value = factor.toFixed(8); // Factor mantiene decimales
                    contador++;
                } else {
                    inputVisual.value = "";
                }
            }
        });
    }

    function abrirModalCrear() {
        document.getElementById("formMantenedor").reset();
        document.getElementById("id_edicion").value = "";
        document.getElementById("inputVisualId").value = "{{ proximo_id }}";
        document.getElementById("modalTitulo").innerText = "Nuevo Dividendo";
        document.getElementById("inputFactorAct").value = "1.000000";
        document.querySelectorAll('.input-factor').forEach(input => input.value = "");
        volverAlPaso1(); // Siempre empezar en paso 1
        var myModal = new bootstrap.Modal(document.getElementById('modalFormulario'));
        myModal.show();
    }

    // LISTENER PARA BOTONES EDITAR
    document.addEventListener('DOMContentLoaded', function() {
        const botonesEditar = document.querySelectorAll('.btn-editar');
        botonesEditar.forEach(btn => {
            btn.addEventListener('click', function() {
                const d = this.dataset;
                
                // Cargar IDs y Textos
                document.getElementById("inputVisualId").value = d.id;
                document.getElementById("id_edicion").value = d.id;
                document.getElementById("modalTitulo").innerText = "Editar Dividendo #" + d.id;
                document.getElementById("inputRut").value = d.rut;
                document.getElementById("inputInstrumento").value = d.instrumento;
                document.getElementById("inputFechaPago").value = d.fecha;
                
                // üî¥ CAMBIO 1: Cargar Monto Hist√≥rico SIN decimales (.toFixed(0))
                document.getElementById("inputMontoHistorico").value = parseFloat(d.montoHist).toFixed(0);
                
                // Factor s√≠ lleva decimales (6)
                document.getElementById("inputFactorAct").value = parseFloat(d.factorAct).toFixed(6);
                
                document.getElementById("inputDescripcion").value = d.descripcion;
                document.getElementById("inputIsfut").checked = (d.isfut === 'true');
                
                // Recalcular para que aparezcan los puntos de miles en el visual
                recalcularTotal();

                // Cargar Factores
                try {
                    const factoresObj = JSON.parse(d.factores);
                    const montoTotalFloat = parseFloat(d.montoTotal);
                    
                    // Limpiar inputs
                    document.querySelectorAll('.input-monto-calculo').forEach(inp => inp.value = "");
                    document.querySelectorAll('.input-factor-visual').forEach(inp => inp.value = "");
                    
                    for (const [key, val] of Object.entries(factoresObj)) {
                        let inputMonto = document.getElementById(key);         // Input $
                        let inputVisual = document.getElementById("visual_" + key); // Input Factor
                        
                        if (inputMonto && inputVisual) {
                            let factor = parseFloat(val);
                            if (factor > 0) {
                                // 1. Llenar Factor Visual (Directo de BD)
                                inputVisual.value = factor.toFixed(8);

                                // 2. Calcular Monto Inverso ($)
                                if (montoTotalFloat > 0) {
                                    let montoCalculado = factor * montoTotalFloat;
                                    // üî¥ CAMBIO 2: Mostrar monto calculado SIN decimales
                                    inputMonto.value = montoCalculado.toFixed(0);
                                }
                            }
                        }
                    }
                } catch (e) { console.error(e); }

                volverAlPaso1(); 
                var myModal = new bootstrap.Modal(document.getElementById('modalFormulario'));
                myModal.show();
            });
        });
    });

    function eliminarRegistro(id) {
        document.getElementById("id_eliminar_input").value = id;
        var myModal = new bootstrap.Modal(document.getElementById('modalEliminar'));
        myModal.show();
    }

    // --- L√ìGICA DE CARGA MASIVA (PREVIEW) ---
    function previsualizarCSV() {
        const input = document.getElementById('input_archivo_csv');
        const zonaPreview = document.getElementById('zona-preview');
        const tablaHead = document.querySelector('#tabla-preview thead');
        const tablaBody = document.querySelector('#tabla-preview tbody');
        const btnGuardar = document.getElementById('btn-confirmar-carga');
        const divError = document.getElementById('error-preview');

        // Limpiar
        zonaPreview.classList.add('d-none');
        divError.classList.add('d-none');
        btnGuardar.disabled = true;
        tablaHead.innerHTML = '';
        tablaBody.innerHTML = '';

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const lineas = text.split('\n').filter(l => l.trim().length > 0);
                
                if (lineas.length < 2) {
                    mostrarError("El archivo est√° vac√≠o."); return;
                }

                // Detectar separador (; o ,)
                const primeraLinea = lineas[0];
                const separador = (primeraLinea.match(/;/g) || []).length > (primeraLinea.match(/,/g) || []).length ? ';' : ',';

                // Encabezados
                const headers = primeraLinea.split(separador).map(h => h.trim().replace(/^"|"$/g, ''));
                
                // Validar columna clave
                if (!headers.some(h => h.toUpperCase().includes('INSTRUMENTO'))) {
                    mostrarError("Falta la columna 'Instrumento'."); return;
                }

                // Dibujar Tabla
                let htmlHead = '<tr>';
                headers.forEach(h => htmlHead += `<th>${h}</th>`);
                htmlHead += '</tr>';
                tablaHead.innerHTML = htmlHead;

                // Dibujar 5 primeras filas
                for (let i = 1; i < Math.min(lineas.length, 6); i++) {
                    let htmlRow = '<tr>';
                    const celdas = lineas[i].split(separador);
                    celdas.forEach(c => htmlRow += `<td>${c.trim().replace(/^"|"$/g, '')}</td>`);
                    htmlRow += '</tr>';
                    tablaBody.innerHTML += htmlRow;
                }

                zonaPreview.classList.remove('d-none');
                btnGuardar.disabled = false;
            };
            reader.readAsText(input.files[0], "ISO-8859-1"); // Ojo con la codificaci√≥n
        }
    }

    function mostrarError(msg) {
        document.getElementById('msg-error-csv').innerText = msg;
        document.getElementById('error-preview').classList.remove('d-none');
    }
</script>
{% endblock %}